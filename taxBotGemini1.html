<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta tags as provided -->
  <meta name="description" content="Calculate your Indian income tax for FY 2023-24 instantly. Free, no signup required. Accurate tax estimation for salaried & self-employed. Plan your taxes now.">
  <meta name="keywords" content="income tax calculator india 2023-24, free tax calculator india, calculate tax online india, income tax slab india, tax estimation india, income tax return filing, budget 2023 india tax, income tax calculation fy24, tax saving schemes india, indian tax laws, tax planning india, digital india tax tools, online tax calculator hindi, indian financial year tax, tax calculator for nri india, free tax calculator for senior citizens india, income tax calculator for ay 2024-25">
  <meta name="robots" content="index, follow">
  <meta name="author" content="Your Name/Your Company (Optional)">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:title" content="Free Income Tax Calculator India | FY 2023-24 | No Signup">
  <meta property="og:description" content="Calculate your Indian income tax for FY 2023-24 instantly. Free, no signup required. Accurate tax estimation for salaried & self-employed. Plan your taxes now.">
  <meta property="og:url" content="https://dpal.site/taxBotGemini1.html">
  <meta property="og:type" content="website">
  <meta property="og:image" content="URL_TO_YOUR_IMAGE">
  <meta name="geo.region" content="IN">
  <meta name="geo.placename" content="India">
  <meta name="geo.position" content="20.5937;78.9629">
  <meta name="ICBM" content="20.5937, 78.9629">
  
  <title>Modern Tax Evaluation Portal</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Fonts: Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- pdf.js for PDF input processing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
  
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f8f9fa;
    }
    .container-custom {
      max-width: 1200px;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .card {
      margin-bottom: 20px;
    }
    .chart-container {
      position: relative;
      height: 300px;
    }
    .nav-tabs .nav-link {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container container-custom">
    <h1 class="text-center mb-4">Modern Tax Evaluation Portal</h1>
    <div id="errorContainer" class="alert alert-danger d-none"></div>
    
    <!-- Input Section -->
    <div class="card">
      <div class="card-header bg-primary text-white">
        Tax Evaluation Form
      </div>
      <div class="card-body">
        <!-- PDF Input at the Top -->
        <div class="mb-3">
          <label for="pdfInput" class="form-label">Upload Form 16 PDF (Optional)</label>
          <input type="file" id="pdfInput" class="form-control" accept="application/pdf">
          <div class="form-text">Upload your Form 16 to auto-populate fields.</div>
        </div>
        <form id="taxForm">
          <!-- Personal Information -->
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="fullName" class="form-label">Full Name</label>
              <input type="text" id="fullName" class="form-control" placeholder="Enter your full name" required>
            </div>
            <div class="col-md-4">
              <label for="panCard" class="form-label">PAN Card Number</label>
              <input type="text" id="panCard" class="form-control" placeholder="Enter PAN card number" required>
            </div>
            <div class="col-md-4">
              <label for="dob" class="form-label">Date of Birth</label>
              <input type="date" id="dob" class="form-control" required>
            </div>
          </div>
          <!-- Contact Details -->
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="email" class="form-label">Email Address</label>
              <input type="email" id="email" class="form-control" placeholder="you@example.com" required>
            </div>
            <div class="col-md-4">
              <label for="mobile" class="form-label">Mobile Number</label>
              <input type="tel" id="mobile" class="form-control" placeholder="Enter mobile number" required>
            </div>
            <div class="col-md-4">
              <label for="address" class="form-label">Residential Address</label>
              <input type="text" id="address" class="form-control" placeholder="Enter your address">
            </div>
          </div>
          <!-- Salary Information -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="grossSalary" class="form-label">Gross Salary (₹)</label>
              <input type="number" id="grossSalary" class="form-control" placeholder="Annual income" required min="0">
            </div>
            <div class="col-md-6">
              <label for="basicSalary" class="form-label">Basic Salary (₹)</label>
              <input type="number" id="basicSalary" class="form-control" placeholder="Basic component" required min="0">
            </div>
          </div>
          <!-- HRA Details -->
          <h5 class="mt-4">HRA Details</h5>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="hraReceived" class="form-label">HRA Received (₹)</label>
              <input type="number" id="hraReceived" class="form-control" placeholder="HRA amount" min="0">
            </div>
            <div class="col-md-6">
              <label for="rentPaid" class="form-label">Rent Paid (₹)</label>
              <input type="number" id="rentPaid" class="form-control" placeholder="Rent amount" min="0">
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="metroCity" class="form-label">Metro City?</label>
              <select id="metroCity" class="form-select">
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>
          <!-- Deductions -->
          <h5 class="mt-4">Deductions</h5>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="ded80c" class="form-label">80C Investments (₹)</label>
              <input type="number" id="ded80c" class="form-control" placeholder="Max ₹1.5 lakh" min="0">
            </div>
            <div class="col-md-6">
              <label for="ded80d" class="form-label">Medical Insurance (80D) (₹)</label>
              <input type="number" id="ded80d" class="form-control" placeholder="Max ₹75k" min="0">
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="ded80e" class="form-label">Education Loan (80E) (₹)</label>
              <input type="number" id="ded80e" class="form-control" placeholder="No limit" min="0">
            </div>
            <div class="col-md-6">
              <label for="ded24b" class="form-label">Home Loan Interest (24b) (₹)</label>
              <input type="number" id="ded24b" class="form-control" placeholder="Max ₹2 lakh" min="0">
            </div>
          </div>
          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button type="button" id="calculateBtn" class="btn btn-success">Calculate Tax</button>
            <button type="button" id="resetBtn" class="btn btn-danger">Reset</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Results Section -->
    <div class="card d-none" id="resultsCard">
      <div class="card-header bg-secondary text-white">
        Tax Evaluation Results
      </div>
      <div class="card-body">
        <ul class="nav nav-tabs" id="resultTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-target="#summaryTab" data-bs-toggle="tab" type="button" role="tab">Summary</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-target="#detailedTab" data-bs-toggle="tab" type="button" role="tab">Detailed</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-target="#compareTab" data-bs-toggle="tab" type="button" role="tab">Compare</button>
          </li>
        </ul>
        <div class="tab-content mt-3">
          <div class="tab-pane fade show active" id="summaryTab" role="tabpanel">
            <div class="chart-container">
              <canvas id="taxChart"></canvas>
            </div>
            <div class="mt-3 text-center">
              <h4>Recommended Regime: <span id="regimeRecommendation">-</span></h4>
              <p id="taxSavings"></p>
            </div>
          </div>
          <div class="tab-pane fade" id="detailedTab" role="tabpanel">
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-dark">
                  <tr>
                    <th>Component</th>
                    <th>Old Regime</th>
                    <th>New Regime</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Gross Income</td>
                    <td id="oldGrossIncome">0</td>
                    <td id="newGrossIncome">0</td>
                  </tr>
                  <tr>
                    <td>Total Deductions</td>
                    <td id="oldTotalDeductions">0</td>
                    <td id="newTotalDeductions">0</td>
                  </tr>
                  <tr class="table-primary">
                    <td>Taxable Income</td>
                    <td id="oldTaxableIncome">0</td>
                    <td id="newTaxableIncome">0</td>
                  </tr>
                  <tr>
                    <td>Income Tax</td>
                    <td id="oldIncomeTax">0</td>
                    <td id="newIncomeTax">0</td>
                  </tr>
                  <tr>
                    <td>Surcharge</td>
                    <td id="oldSurcharge">0</td>
                    <td id="newSurcharge">0</td>
                  </tr>
                  <tr class="table-primary">
                    <td>Total Tax</td>
                    <td id="oldTotalTax">0</td>
                    <td id="newTotalTax">0</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="tab-pane fade" id="compareTab" role="tabpanel">
            <div class="row">
              <div class="col-md-6">
                <div class="alert alert-info text-center">
                  <h5>Effective Tax Rate</h5>
                  <p id="oldEffectiveRate">-</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="alert alert-info text-center">
                  <h5>Monthly Take-home</h5>
                  <p id="oldMonthly">-</p>
                </div>
              </div>
            </div>
            <div class="table-responsive mt-3">
              <table class="table table-bordered">
                <thead class="table-dark">
                  <tr>
                    <th>Feature</th>
                    <th>Old Regime</th>
                    <th>New Regime</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Deductions Available</td>
                    <td>70+ Sections</td>
                    <td>Limited</td>
                  </tr>
                  <tr>
                    <td>Standard Deduction</td>
                    <td>₹50,000</td>
                    <td>₹50,000</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- Deduction Breakdown -->
        <div id="breakdownSection" class="mt-4 d-none">
          <h5>Old Regime Deduction Breakdown</h5>
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead class="table-dark">
                <tr>
                  <th>Deduction Component</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>HRA Exemption</td>
                  <td id="breakdownHRA">0</td>
                </tr>
                <tr>
                  <td>80C Deduction</td>
                  <td id="breakdown80C">0</td>
                </tr>
                <tr>
                  <td>80D Deduction</td>
                  <td id="breakdown80D">0</td>
                </tr>
                <tr>
                  <td>80E Deduction</td>
                  <td id="breakdown80E">0</td>
                </tr>
                <tr>
                  <td>Home Loan Interest (24b)</td>
                  <td id="breakdown24b">0</td>
                </tr>
                <tr>
                  <td>Standard Deduction</td>
                  <td id="breakdownStandard">0</td>
                </tr>
                <tr class="table-primary">
                  <td>Total Deductions</td>
                  <td id="breakdownTotal">0</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="d-flex justify-content-end mt-3">
          <button id="downloadBtn" class="btn btn-success me-2">Download Full Report</button>
          <button id="resetBtnResults" class="btn btn-danger">Reset Results</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Firebase Initialization -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDoe6v3NbbMceeFnh-XH6Fp74DqqSLYlVE",
      authDomain: "gaanaai.firebaseapp.com",
      projectId: "gaanaai",
      storageBucket: "gaanaai.firebasestorage.app",
      messagingSenderId: "1033414979244",
      appId: "1:1033414979244:web:3c91428cef18246fe17909",
      measurementId: "G-67SQ4QEE0P"
    };
    firebase.initializeApp(firebaseConfig);
    const firestore = firebase.firestore();
    const storage = firebase.storage();
  </script>
  
  <!-- Main Script -->
  <script>
    const { jsPDF } = window.jspdf;
    let taxChart = null;
    
    // Helper function to safely set textContent for an element.
    function setText(id, value) {
      const elem = document.getElementById(id);
      if (elem) {
        elem.textContent = value;
      } else {
        console.error(`Element with id "${id}" not found.`);
      }
    }
    
    // Custom extraction function for Form 16 text.
    function extractDataFromForm16Text(text) {
      const data = {};
      // Extract full name from "Name and address of the Employee"
      const empMatch = text.match(/Name and address of the Employee\/Specified senior citizen\s+([\sA-Z]+)\s+/i);
      if (empMatch) data.fullName = empMatch[1].trim();
      // Extract PAN of employee
      const panMatch = text.match(/PAN\s+of\s+the\s+Employee[\s\S]+?([A-Z0-9]{10})/i);
      if (panMatch) data.panCard = panMatch[1].trim();
      // Extract DOB (if available, in YYYY-MM-DD format)
      const dobMatch = text.match(/DOB:\s*([\d]{4}-[\d]{2}-[\d]{2})/i);
      if (dobMatch) data.dob = dobMatch[1].trim();
      // Extract Gross Salary from a line like "Salary as per provisions contained in section 17(1)(a)"
      const grossSalaryMatch = text.match(/Salary as per provisions contained in section 17\(1\)\(a\)[\s:]*([\d,]+\.\d+)/i);
      if (grossSalaryMatch) data.grossSalary = grossSalaryMatch[1].replace(/,/g, '').trim();
      return data;
    }
    
    class TaxCalculator {
      constructor() {
        this.taxConfig = {
          oldRegime: {
            slabs: [
              { limit: 250000, rate: 0 },
              { limit: 500000, rate: 0.05 },
              { limit: 1000000, rate: 0.2 },
              { limit: Infinity, rate: 0.3 }
            ],
            deductions: {
              "80C": 150000,
              "80D": { below60: 25000, above60: 50000 },
              "80E": Infinity,
              "24b": 200000,
              standard: 50000
            }
          },
          newRegime: {
            slabs: [
              { limit: 300000, rate: 0 },
              { limit: 600000, rate: 0.05 },
              { limit: 900000, rate: 0.1 },
              { limit: 1200000, rate: 0.15 },
              { limit: 1500000, rate: 0.2 },
              { limit: Infinity, rate: 0.3 }
            ],
            standardDeduction: 50000
          },
          cess: 0.04,
          surcharge: {
            5000000: 0.10,
            10000000: 0.15,
            20000000: 0.25,
            50000000: 0.37
          }
        };
      }
      
      calculateHRAExemption(basic, hraReceived, rentPaid, isMetro) {
        const metroPercentage = isMetro ? 0.5 : 0.4;
        const computedValue = Math.min(hraReceived, rentPaid - (basic * 0.1), basic * metroPercentage);
        return Math.max(computedValue, 0);
      }
      
      calculateOldRegime(data) {
        const hraExemption = this.calculateHRAExemption(
          data.basicSalary,
          data.hraReceived,
          data.rentPaid,
          data.metroCity === 'yes'
        );
        const applied80C = Math.min(data.deductions80C, this.taxConfig.oldRegime.deductions["80C"]);
        const applied80D = Math.min(
          data.deductions80D,
          data.age >= 60 ? this.taxConfig.oldRegime.deductions["80D"].above60 
                         : this.taxConfig.oldRegime.deductions["80D"].below60
        );
        const applied80E = data.deductions80E;
        const applied24b = Math.min(data.deductions24b, this.taxConfig.oldRegime.deductions["24b"]);
        const standardDeduction = this.taxConfig.oldRegime.deductions.standard;
        
        let totalDeductions = hraExemption + applied80C + applied80D + applied80E + applied24b + standardDeduction;
        let taxableIncome = data.grossSalary - totalDeductions;
        taxableIncome = Math.max(taxableIncome, 0);
        
        let tax = this.applySlabs(taxableIncome, 'old');
        const surcharge = this.calculateSurcharge(tax, data.grossSalary);
        tax = Math.round((tax + surcharge) * (1 + this.taxConfig.cess));
        
        return {
          taxableIncome: taxableIncome,
          tax: tax,
          surcharge: surcharge,
          breakdown: {
            hraExemption: hraExemption,
            applied80C: applied80C,
            applied80D: applied80D,
            applied80E: applied80E,
            applied24b: applied24b,
            standardDeduction: standardDeduction,
            totalDeductions: totalDeductions
          }
        };
      }
      
      calculateNewRegime(data) {
        let taxableIncome = data.grossSalary - this.taxConfig.newRegime.standardDeduction;
        taxableIncome = Math.max(taxableIncome, 0);
        let tax = this.applySlabs(taxableIncome, 'new');
        const surcharge = this.calculateSurcharge(tax, data.grossSalary);
        tax = Math.round((tax + surcharge) * (1 + this.taxConfig.cess));
        
        return {
          taxableIncome: taxableIncome,
          tax: tax,
          surcharge: surcharge
        };
      }
      
      applySlabs(income, regime) {
        const slabs = this.taxConfig[`${regime}Regime`].slabs;
        let tax = 0, previousLimit = 0;
        for (const slab of slabs) {
          const currentLimit = slab.limit;
          const taxableInSlab = Math.max(Math.min(income, currentLimit) - previousLimit, 0);
          tax += taxableInSlab * slab.rate;
          previousLimit = currentLimit;
          if (income <= currentLimit) break;
        }
        return tax;
      }
      
      calculateSurcharge(tax, grossIncome) {
        const thresholds = Object.keys(this.taxConfig.surcharge).map(Number).sort((a, b) => b - a);
        for (const threshold of thresholds) {
          if (grossIncome > threshold) return tax * this.taxConfig.surcharge[threshold];
        }
        return 0;
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      const calculateBtn = document.getElementById('calculateBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const resetBtnResults = document.getElementById('resetBtnResults');
      const resetBtnForm = document.getElementById('resetBtn');
      const pdfInput = document.getElementById('pdfInput');
      const tabs = document.querySelectorAll('.nav-link');
      
      // Set max for DOB input to today
      const dobInput = document.getElementById('dob');
      dobInput.setAttribute('max', new Date().toISOString().split('T')[0]);
      
      // When a PDF is uploaded, extract text and auto-fill the form using our custom extraction function.
      pdfInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function() {
          const typedarray = new Uint8Array(this.result);
          pdfjsLib.getDocument(typedarray).promise.then(pdf => {
            let countPromises = [];
            for (let j = 1; j <= pdf.numPages; j++) {
              countPromises.push(pdf.getPage(j).then(page => {
                return page.getTextContent().then(textContent => {
                  return textContent.items.map(item => item.str).join(" ");
                });
              }));
            }
            Promise.all(countPromises).then(texts => {
              const allText = texts.join(" ");
              console.log("Extracted text: ", allText);
              const extractedData = extractDataFromForm16Text(allText);
              if (extractedData.fullName) document.getElementById('fullName').value = extractedData.fullName;
              if (extractedData.panCard) document.getElementById('panCard').value = extractedData.panCard;
              if (extractedData.dob) document.getElementById('dob').value = extractedData.dob;
              if (extractedData.grossSalary) document.getElementById('grossSalary').value = extractedData.grossSalary;
              alert("PDF processed and form populated (if matching data was found).");
            });
          });
        };
        reader.readAsArrayBuffer(file);
      });
      
      function showError(message) {
        const errorContainer = document.getElementById('errorContainer');
        errorContainer.innerHTML = `<strong>Error:</strong> ${message}<br><small>Please check your inputs and try again</small>`;
        errorContainer.classList.remove('d-none');
        window.scrollTo(0, 0);
      }
      
      function clearErrors() {
        document.getElementById('errorContainer').classList.add('d-none');
      }
      
      function showTab(tabName) {
        const tabTrigger = document.querySelector('[data-bs-target="#' + tabName + 'Tab"]');
        new bootstrap.Tab(tabTrigger).show();
      }
      
      function formatCurrency(value) {
        return "₹" + Number(value).toLocaleString('en-IN', { maximumFractionDigits: 0 });
      }
      
      // updateResults function to display computed tax results with safe element updates.
      function updateResults(oldRegime, newRegime, inputData) {
        setText("regimeRecommendation", oldRegime.tax < newRegime.tax ? "Old Regime" : "New Regime");
        setText("taxSavings", `Potential Savings: ${formatCurrency(Math.abs(oldRegime.tax - newRegime.tax))}`);
        setText("oldGrossIncome", formatCurrency(inputData.grossSalary));
        setText("newGrossIncome", formatCurrency(inputData.grossSalary));
        setText("oldTotalDeductions", formatCurrency(inputData.grossSalary - oldRegime.taxableIncome));
        setText("newTotalDeductions", formatCurrency(inputData.grossSalary - newRegime.taxableIncome));
        setText("oldTaxableIncome", formatCurrency(oldRegime.taxableIncome));
        setText("newTaxableIncome", formatCurrency(newRegime.taxableIncome));
        setText("oldTotalTax", formatCurrency(oldRegime.tax));
        setText("newTotalTax", formatCurrency(newRegime.tax));
        setText("oldSurcharge", formatCurrency(oldRegime.surcharge));
        setText("newSurcharge", formatCurrency(newRegime.surcharge));
        setText("oldEffectiveRate", ((oldRegime.tax / inputData.grossSalary) * 100).toFixed(1) + "%");
        setText("newEffectiveRate", ((newRegime.tax / inputData.grossSalary) * 100).toFixed(1) + "%");
        setText("oldMonthly", formatCurrency((inputData.grossSalary - oldRegime.tax) / 12));
        setText("newMonthly", formatCurrency((inputData.grossSalary - newRegime.tax) / 12));
        
        if (taxChart) taxChart.destroy();
        taxChart = new Chart(document.getElementById("taxChart"), {
          type: "doughnut",
          data: {
            labels: ["Tax Paid", "Take Home"],
            datasets: [{
              data: [oldRegime.tax, inputData.grossSalary - oldRegime.tax],
              backgroundColor: ["#e74c3c", "#2ecc71"]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom" },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return " " + formatCurrency(context.parsed);
                  }
                }
              }
            }
          }
        });
        
        if (oldRegime.breakdown) {
          setText("breakdownHRA", formatCurrency(oldRegime.breakdown.hraExemption));
          setText("breakdown80C", formatCurrency(oldRegime.breakdown.applied80C));
          setText("breakdown80D", formatCurrency(oldRegime.breakdown.applied80D));
          setText("breakdown80E", formatCurrency(oldRegime.breakdown.applied80E));
          setText("breakdown24b", formatCurrency(oldRegime.breakdown.applied24b));
          setText("breakdownStandard", formatCurrency(oldRegime.breakdown.standardDeduction));
          setText("breakdownTotal", formatCurrency(oldRegime.breakdown.totalDeductions));
          document.getElementById("breakdownSection").classList.remove("d-none");
        }
        document.getElementById("resultsCard").classList.remove("d-none");
      }
      
      // Helper to safely set element textContent
      function setText(id, value) {
        const elem = document.getElementById(id);
        if (elem) {
          elem.textContent = value;
        } else {
          console.error(`Element with id "${id}" not found.`);
        }
      }
      
      // Store data in Firebase (Firestore and Storage)
      async function storeData(formData, pdfFile) {
        try {
          let pdfURL = "";
          if (pdfFile) {
            const storageRef = storage.ref();
            const fileRef = storageRef.child("pdfUploads/" + Date.now() + "_" + pdfFile.name);
            await fileRef.put(pdfFile);
            pdfURL = await fileRef.getDownloadURL();
            formData.pdfURL = pdfURL;
          }
          await firestore.collection("taxSubmissions").add(formData);
          console.log("Data saved successfully to Firebase.");
        } catch (error) {
          console.error("Error saving data to Firebase:", error);
        }
      }
      
      async function captureElement(elementId) {
        const element = document.getElementById(elementId);
        const originalDisplay = element.style.display;
        element.style.display = "block";
        const canvas = await html2canvas(element, { scale: 2 });
        element.style.display = originalDisplay;
        return canvas.toDataURL("image/png");
      }
      
      async function generatePDF() {
        const doc = new jsPDF("p", "pt", "a4");
        const margin = 20;
        let verticalOffset = margin;
        doc.setFontSize(18);
        doc.text("Tax Calculation Report", margin, verticalOffset);
        verticalOffset += 30;
        const fullName = document.getElementById("fullName").value;
        const panCard = document.getElementById("panCard").value;
        const dob = document.getElementById("dob").value;
        const grossSalary = document.getElementById("grossSalary").value;
        const basicSalary = document.getElementById("basicSalary").value;
        doc.setFontSize(12);
        doc.text("Taxpayer Information:", margin, verticalOffset);
        verticalOffset += 15;
        doc.text("Full Name: " + fullName, margin, verticalOffset);
        verticalOffset += 15;
        doc.text("PAN Card: " + panCard, margin, verticalOffset);
        verticalOffset += 15;
        doc.text("Date of Birth: " + dob, margin, verticalOffset);
        verticalOffset += 15;
        doc.text("Gross Salary: " + grossSalary, margin, verticalOffset);
        verticalOffset += 15;
        doc.text("Basic Salary: " + basicSalary, margin, verticalOffset);
        verticalOffset += 25;
        
        const summaryImgData = await captureElement("summaryTab");
        const pageWidth = doc.internal.pageSize.getWidth() - margin * 2;
        let imgProps = doc.getImageProperties(summaryImgData);
        let imgHeight = (imgProps.height * pageWidth) / imgProps.width;
        if (verticalOffset + imgHeight > doc.internal.pageSize.getHeight() - margin) {
          doc.addPage();
          verticalOffset = margin;
        }
        doc.addImage(summaryImgData, "PNG", margin, verticalOffset, pageWidth, imgHeight);
        verticalOffset += imgHeight + 20;
        
        const detailedImgData = await captureElement("detailedTab");
        imgProps = doc.getImageProperties(detailedImgData);
        imgHeight = (imgProps.height * pageWidth) / imgProps.width;
        if (verticalOffset + imgHeight > doc.internal.pageSize.getHeight() - margin) {
          doc.addPage();
          verticalOffset = margin;
        }
        doc.text("Detailed Analysis (Old vs New Regime):", margin, verticalOffset);
        verticalOffset += 15;
        doc.addImage(detailedImgData, "PNG", margin, verticalOffset, pageWidth, imgHeight);
        verticalOffset += imgHeight + 20;
        
        const compareImgData = await captureElement("compareTab");
        imgProps = doc.getImageProperties(compareImgData);
        imgHeight = (imgProps.height * pageWidth) / imgProps.width;
        if (verticalOffset + imgHeight > doc.internal.pageSize.getHeight() - margin) {
          doc.addPage();
          verticalOffset = margin;
        }
        doc.text("Comparison:", margin, verticalOffset);
        verticalOffset += 15;
        doc.addImage(compareImgData, "PNG", margin, verticalOffset, pageWidth, imgHeight);
        verticalOffset += imgHeight + 20;
        
        const breakdownElement = document.getElementById("breakdownSection");
        if (breakdownElement && !breakdownElement.classList.contains("d-none")) {
          const breakdownImgData = await captureElement("breakdownSection");
          imgProps = doc.getImageProperties(breakdownImgData);
          imgHeight = (imgProps.height * pageWidth) / imgProps.width;
          if (verticalOffset + imgHeight > doc.internal.pageSize.getHeight() - margin) {
            doc.addPage();
            verticalOffset = margin;
          }
          doc.text("Deduction Breakdown (Old Regime):", margin, verticalOffset);
          verticalOffset += 15;
          doc.addImage(breakdownImgData, "PNG", margin, verticalOffset, pageWidth, imgHeight);
          verticalOffset += imgHeight + 20;
        }
        doc.save("tax-report.pdf");
      }
      
      function calculateTax() {
        try {
          clearErrors();
          // Validate required fields with descriptive messages.
          const requiredFields = [
            { id: "fullName", name: "Full Name" },
            { id: "panCard", name: "PAN Card Number" },
            { id: "dob", name: "Date of Birth" },
            { id: "email", name: "Email Address" },
            { id: "mobile", name: "Mobile Number" },
            { id: "grossSalary", name: "Gross Salary" },
            { id: "basicSalary", name: "Basic Salary" }
          ];
          for (const field of requiredFields) {
            const value = document.getElementById(field.id).value;
            if (!value) {
              throw new Error(`The field "${field.name}" is required.`);
            }
          }
          if (new Date(document.getElementById("dob").value) > new Date()) {
            throw new Error("Date of Birth cannot be in the future.");
          }
          
          const grossSalary = parseFloat(document.getElementById("grossSalary").value);
          const basicSalary = parseFloat(document.getElementById("basicSalary").value);
          if (isNaN(grossSalary) || grossSalary <= 0) throw new Error("Gross Salary must be a positive number.");
          if (isNaN(basicSalary) || basicSalary <= 0) throw new Error("Basic Salary must be a positive number.");
          if (basicSalary > grossSalary) throw new Error("Basic Salary cannot be greater than Gross Salary.");
          
          const inputsToCheck = ["hraReceived", "rentPaid", "ded80c", "ded80d", "ded80e", "ded24b"];
          for (const id of inputsToCheck) {
            const val = parseFloat(document.getElementById(id).value) || 0;
            if (val < 0) throw new Error(`The field "${id}" cannot be negative.`);
          }
          
          const dob = new Date(document.getElementById("dob").value);
          const age = new Date().getFullYear() - dob.getFullYear();
          const inputData = {
            grossSalary: grossSalary,
            basicSalary: basicSalary,
            hraReceived: parseFloat(document.getElementById("hraReceived").value) || 0,
            rentPaid: parseFloat(document.getElementById("rentPaid").value) || 0,
            metroCity: document.getElementById("metroCity").value,
            deductions80C: Math.min(parseFloat(document.getElementById("ded80c").value) || 0, 150000),
            deductions80D: Math.min(parseFloat(document.getElementById("ded80d").value) || 0, age >= 60 ? 50000 : 25000),
            deductions80E: parseFloat(document.getElementById("ded80e").value) || 0,
            deductions24b: Math.min(parseFloat(document.getElementById("ded24b").value) || 0, 200000),
            age: age
          };
          
          const calculator = new TaxCalculator();
          const oldRegime = calculator.calculateOldRegime(inputData);
          const newRegime = calculator.calculateNewRegime(inputData);
          showTab("summary");
          updateResults(oldRegime, newRegime, inputData);
          
          // Prepare form data for Firebase.
          const formData = {
            fullName: document.getElementById("fullName").value,
            panCard: document.getElementById("panCard").value,
            dob: document.getElementById("dob").value,
            email: document.getElementById("email").value,
            mobile: document.getElementById("mobile").value,
            address: document.getElementById("address").value,
            grossSalary: grossSalary,
            basicSalary: basicSalary,
            hraReceived: inputData.hraReceived,
            rentPaid: inputData.rentPaid,
            metroCity: inputData.metroCity,
            ded80c: document.getElementById("ded80c").value,
            ded80d: document.getElementById("ded80d").value,
            ded80e: document.getElementById("ded80e").value,
            ded24b: document.getElementById("ded24b").value,
            oldRegime: oldRegime,
            newRegime: newRegime,
            submittedAt: new Date().toISOString()
          };
          
          const pdfFile = document.getElementById("pdfInput").files[0];
          storeData(formData, pdfFile);
          
        } catch (error) {
          showError(error.message);
        }
      }
      
      calculateBtn.addEventListener("click", calculateTax);
      downloadBtn.addEventListener("click", generatePDF);
      resetBtnForm.addEventListener("click", function() {
        document.getElementById("taxForm").reset();
        clearErrors();
      });
      resetBtnResults.addEventListener("click", function() {
        document.getElementById("resultsCard").classList.add("d-none");
        if (taxChart) taxChart.destroy();
      });
      tabs.forEach(tab => {
        tab.addEventListener("click", function() {
          const target = this.getAttribute("data-bs-target").substring(1);
          showTab(target);
        });
      });
    });
  </script>
</body>
</html>
